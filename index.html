<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>蛇 vs 馬 TD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: sans-serif;
    }

    #ui {
      text-align: center;
      padding: 6px;
    }

    button {
      margin: 4px;
      padding: 6px;
    }

    canvas {
      display: block;
      margin: auto;
      background: #222;
      touch-action: none;
    }
  </style>
</head>

<body>

  <div id="ui">
    コスト: <span id="cost">10</span> |
    生存: <span id="time">0</span>s
  </div>

  <canvas id="game" width="360" height="560"></canvas>

  <div id="ui">
    <button draggable="true" data-type="normal">へび(3)</button>
    <button draggable="true" data-type="producer">生産(5)</button>
    <button draggable="true" data-type="poison">毒(6)</button>
    <button draggable="true" data-type="stone">石化(7)</button>
  </div>

  <script>
    // =====================
    // 基本設定
    // =====================
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const FPS = 60;
    const FRAME_TIME = 1000 / FPS;

    let frame = 0;        // ロジック用フレーム
    let second = 0;       // 実時間（表示用）
    let cost = 10;
    let gameOver = false;

    let lastTime = performance.now();
    let accumulator = 0;

    let draggingType = null;
    let selected = null;

    // =====================
    // ゲームデータ
    // =====================
    const lanes = [60, 180, 300];
    const defenseLine = canvas.height - 40;

    const snakes = [];
    const enemies = [];
    const effects = [];

    const snakeTypes = {
      normal: { cost: 3, rate: 60, dmg: 1, range: 70 },
      producer: { cost: 5, produce: 180, range: 40 },
      poison: { cost: 6, rate: 80, dmg: 1, poison: 0.03, range: 60 },
      stone: {
        cost: 7,
        rate: 120,
        slow: 0.8,     // 40%速度
        slowTime: 120, // 2秒
        range: 50
      }

    };

    // =====================
    // UI操作
    // =====================
    document.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("dragstart", () => draggingType = btn.dataset.type);
      btn.addEventListener("touchstart", () => draggingType = btn.dataset.type);
    });

    canvas.addEventListener("dragover", e => e.preventDefault());

    canvas.addEventListener("drop", e => {
      const r = canvas.getBoundingClientRect();
      placeSnake(e.clientX - r.left, e.clientY - r.top);
    });

    canvas.addEventListener("touchend", e => {
      const t = e.changedTouches[0];
      const r = canvas.getBoundingClientRect();
      placeSnake(t.clientX - r.left, t.clientY - r.top);
    });

    canvas.addEventListener("click", e => {
      if (draggingType) return;
      const r = canvas.getBoundingClientRect();
      selectEntity(e.clientX - r.left, e.clientY - r.top);
    });

    function placeSnake(x, y) {
      if (!draggingType) return;
      const t = snakeTypes[draggingType];
      if (cost < t.cost || y < 80 || y > defenseLine) return;
      cost -= t.cost;
      snakes.push({ x, y, type: draggingType, timer: 0 });
      draggingType = null;
    }

    function selectEntity(x, y) {
      selected = null;
      snakes.forEach(s => {
        if (Math.hypot(x - s.x, y - s.y) < 10) selected = { kind: "snake", data: s };
      });
      enemies.forEach(e => {
        if (Math.hypot(x - e.x, y - e.y) < 12) selected = { kind: "enemy", data: e };
      });
    }

    // =====================
    // 敵生成
    // =====================
    function spawnEnemy() {
      const hp = 10 + frame * 0.001;
      enemies.push({
        x: lanes[Math.floor(Math.random() * lanes.length)],
        y: -20,
        hp,
        maxHp: hp,
        speed: 0.10 + frame * 0.0001,
        slow: 1,
        slowTimer: 0,
        poison: 0
      });
    }

    // =====================
    // ロジック更新（固定FPS）
    // =====================
    function updateLogic() {
      if (gameOver) return;

      frame++;

      if (frame % FPS === 0) {
        second++;
        cost++;
      }

      const spawnInterval = Math.max(120 - frame / 30, 50);
      if (frame % spawnInterval === 0) {
        spawnEnemy();
      }

      // 蛇
      snakes.forEach(s => {
        s.timer++;
        const t = snakeTypes[s.type];

        if (t.produce && s.timer % t.produce === 0) {
          cost++;
        }

        enemies.forEach(e => {
          const d = Math.hypot(e.x - s.x, e.y - s.y);
          if (d < t.range && t.rate && s.timer % t.rate === 0) {
            e.hp -= t.dmg || 0;
            if (t.poison) e.poison += t.poison;
            //if (t.stun) e.stun = t.stun;
            if (t.slow) {
              e.slow = t.slow;
              e.slowTimer = t.slowTime;
            }

            effects.push({ x: e.x, y: e.y, text: `-${t.dmg || 0}`, life: 30 });
          }
        });
      });

      // 敵
      enemies.forEach(e => {
        //if (e.stun > 0) { e.stun--; return; }
        if (e.slowTimer > 0) {
          e.slowTimer--;
        } else {
          e.slow = 1;
        }
        e.y += e.speed * e.slow;
        e.hp -= e.poison;
        if (e.y > defenseLine) gameOver = true;
      });

      for (let i = enemies.length - 1; i >= 0; i--) {
        if (enemies[i].hp <= 0) enemies.splice(i, 1);
      }

      // エフェクト
      for (let i = effects.length - 1; i >= 0; i--) {
        effects[i].y -= 0.5;
        effects[i].life--;
        if (effects[i].life <= 0) effects.splice(i, 1);
      }
    }

    // =====================
    // 描画
    // =====================
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // レーン
      ctx.strokeStyle = "#333";
      lanes.forEach(x => {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      });

      // 防衛ライン
      ctx.strokeStyle = "red";
      ctx.beginPath();
      ctx.moveTo(0, defenseLine);
      ctx.lineTo(canvas.width, defenseLine);
      ctx.stroke();

      // 蛇
      snakes.forEach(s => {
        const t = snakeTypes[s.type];
        ctx.fillStyle = "rgba(0,255,0,0.08)";
        ctx.beginPath();
        ctx.arc(s.x, s.y, t.range, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "green";
        ctx.fillRect(s.x - 8, s.y - 8, 16, 16);
      });

      // 敵＋HPバー
      enemies.forEach(e => {
        ctx.fillStyle = e.slow < 1 ? "#777" : "brown";
        ctx.fillRect(e.x - 10, e.y - 10, 20, 20);

        ctx.fillStyle = "red";
        ctx.fillRect(e.x - 12, e.y - 16, 24 * (e.hp / e.maxHp), 3);
        ctx.strokeStyle = "#000";
        ctx.strokeRect(e.x - 12, e.y - 16, 24, 3);
      });

      // ダメージ
      effects.forEach(f => {
        ctx.fillStyle = `rgba(255,255,255,${f.life / 30})`;
        ctx.fillText(f.text, f.x, f.y);
      });

      // ステータス
      if (selected) {
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(200, 10, 150, 60);
        ctx.fillStyle = "#fff";
        ctx.fillText(
          selected.kind === "enemy"
            ? `馬 HP:${Math.ceil(selected.data.hp)}`
            : `蛇:${selected.data.type}`,
          210, 40
        );
      }

      document.getElementById("cost").textContent = cost;
      document.getElementById("time").textContent = second;

      if (gameOver) {
        ctx.fillStyle = "#fff";
        ctx.fillText(`敗北 生存 ${second} 秒`, 90, 300);
      }
    }

    // =====================
    // ゲームループ
    // =====================
    function gameLoop(now) {
      const delta = now - lastTime;
      lastTime = now;
      accumulator += delta;

      while (accumulator >= FRAME_TIME) {
        updateLogic();
        accumulator -= FRAME_TIME;
      }

      draw();
      requestAnimationFrame(gameLoop);
    }

    requestAnimationFrame(gameLoop);
  </script>
</body>

</html>