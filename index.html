<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>へびの一年</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #0f0f0f;
    overflow: hidden;
    touch-action: manipulation;
    font-family: system-ui, sans-serif;
  }
  #message {
    position: fixed;
    top: 20px;
    width: 100%;
    text-align: center;
    color: #fff;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s;
    z-index: 10;
  }
  canvas {
    display: block;
  }
</style>
</head>
<body>

<div id="message"></div>
<canvas id="game"></canvas>

<script>
/* =====================
   Canvasサイズ調整
===================== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

const messageBox = document.getElementById("message");

/* =====================
   プレイヤー（世界座標）
===================== */
const player = {
  x: 0,
  y: 0,
  vx: 1,
  vy: 0,
  w: 24,
  h: 24,
  onGround: false
};

/* =====================
   カメラ
===================== */
const camera = {
  x: 0
};

/* =====================
   地形（世界座標）
===================== */
function groundY(worldX) {
  if (worldX < 300) return canvas.height * 0.75 - worldX * 0.2;        // 山①
  if (worldX < 500) return canvas.height * 0.55 + (worldX - 300) * 0.5; // 谷①
  if (worldX < 800) return canvas.height * 0.8;                         // 平坦
  return canvas.height * 0.8 - (worldX - 800) * 0.25;                   // 山②
}

/* =====================
   チェックポイント
===================== */
const checkpoints = [
  { x: 350, done: false, prompt: "今年、しんどかったこと" },
  { x: 900, done: false, prompt: "今年、楽しかったこと" }
];

/* =====================
   メッセージ
===================== */
function showMessage(text, time = 2000) {
  messageBox.textContent = text;
  messageBox.style.opacity = 1;
  setTimeout(() => messageBox.style.opacity = 0, time);
}

showMessage("画面をタップして進んでみよう", 3000);

/* =====================
   入力（タップのみ）
===================== */
function tryJump() {
  if (player.onGround) {
    player.vy = -10;
    player.onGround = false;
  }
}

window.addEventListener("mousedown", tryJump);
window.addEventListener("touchstart", e => {
  e.preventDefault();
  tryJump();
}, { passive: false });

/* =====================
   メインループ
===================== */
function update() {
  // 自動前進
  player.vx = Math.min(player.vx + 0.002, 2);

  // 重力
  player.vy += 0.5;

  // 移動
  player.x += player.vx;
  player.y += player.vy;

  // 地面判定
  const gy = groundY(player.x);
  if (player.y + player.h > gy) {
    player.y = gy - player.h;
    player.vy = 0;
    player.onGround = true;
  }

  // カメラ追従（プレイヤーを中央寄せ）
  camera.x = player.x - canvas.width * 0.35;

  // チェックポイント
  checkpoints.forEach(cp => {
    if (!cp.done && player.x > cp.x) {
      cp.done = true;
      const input = prompt(cp.prompt);
      console.log(cp.prompt, input);
      showMessage("少し、進めるようになった");
    }
  });

  draw();
  requestAnimationFrame(update);
}

/* =====================
   描画
===================== */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 地形描画
  ctx.strokeStyle = "#666";
  ctx.beginPath();
  for (let sx = 0; sx < canvas.width; sx += 5) {
    const wx = sx + camera.x;
    ctx.lineTo(sx, groundY(wx));
  }
  ctx.stroke();

  // プレイヤー描画（画面座標）
  const screenX = player.x - camera.x;
  ctx.fillStyle = "#6fdc6f";
  ctx.fillRect(screenX, player.y, player.w, player.h);
}

update();
</script>

</body>
</html>
