<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>蛇 vs 馬 TD 再生</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            background: #111;
            color: #fff;
            font-family: sans-serif;
            text-align: center;
        }

        canvas {
            display: block;
            margin: auto;
            background: #222;
            touch-action: none;
        }

        #ui {
            text-align: center;
            padding: 6px;
        }

        button {
            margin: 4px;
            padding: 6px;
        }

        textarea {
            width: 90%;
            height: 120px;
            background: #222;
            color: #0f0;
            font-family: monospace;
            margin: 8px 0;
            border: 1px solid #555;
            padding: 6px;
        }

        textarea:disabled {
            background: #333;
            color: #888;
        }
    </style>
</head>

<body>
    <h2>再生</h2>

    <div id="ui">
        <textarea id="kif-input" placeholder="ここに棋譜(JSON)を貼り付けてください"></textarea>
        <br>
        <button id="load-kif-btn">読み込み＆再生</button>
    </div>

    <div id="ui">
        再生速度: <span id="speed">x1</span>
        <button onclick="setSpeed(1)">x1</button>
        <button onclick="setSpeed(2)">x2</button>
        <button onclick="setSpeed(3)">x3</button>
        <button onclick="setSpeed(5)">x5</button>
        <button onclick="setSpeed(10)">x10</button>
    </div>

    <div id="ui">
        お金: <span id="cost">10</span> |
        生存: <span id="time">0</span>s
    </div>

    <canvas id="game" width="360" height="560"></canvas>

    <script src="setting.js"></script>
    <script src="index.js"></script>
    <script defer>
        let kifData = [];
        let recordIndex = 0;
        let gameStarted = false;

        const loadBtn = document.getElementById("load-kif-btn");
        const kifInput = document.getElementById("kif-input");

        // 再生速度制御
        function setSpeed(v) {
            speedMultiplier = v;
            const el = document.getElementById("speed");
            if (el) el.textContent = "x" + v;
        }

        // loadボタンで棋譜読み込み
        loadBtn.onclick = () => {
            try {
                const data = JSON.parse(kifInput.value);
                if (!Array.isArray(data)) throw "棋譜が配列ではありません";
                kifData = data;

                // 初期化
                frame = 0;
                second = 0;
                cost = 10;
                snakes.length = 0;
                enemies.length = 0;
                effects.length = 0;
                costEffects.length = 0;
                enemiesDefeated = 0;
                gameOver = false;
                recordIndex = 0;
                gameStarted = true;

                requestAnimationFrame(gameLoop);
            } catch (e) {
                alert("棋譜の読み込みに失敗しました: " + e);
            }
        };

        // updateLogicを棋譜再生対応に上書き
        const originalUpdateLogic = updateLogic;
        updateLogic = function () {
            if (gameOver) return;

            frame++;

            // ---------------------------
            // 棋譜再生による蛇の配置・強化
            // ---------------------------
            if (gameStarted && kifData && recordIndex < kifData.length) {
                while (recordIndex < kifData.length && kifData[recordIndex].frame <= frame) {
                    const act = kifData[recordIndex];

                    if (act.action === "placeSnake") {
                        snakes.push({ ...act, timer: 0 });

                    } else if (act.action === "upgradeSnake") {
                        const s = snakes.find(s => s.id === act.id);
                        if (s) s.level = act.level;
                    }

                    recordIndex++;
                }
            }

            // ---------------------------
            // 通常の時間処理
            // ---------------------------
            if (frame % FPS === 0) {
                second++;
                cost++;
            }

            // ---------------------------
            // 敵の自動生成（index.js と同じロジック）
            // ---------------------------
            const spawnInterval = Math.max(120 - frame / 30, 50); // 出現間隔を徐々に短縮
            if (frame % spawnInterval === 0) {
                spawnEnemy(); // index.js と同じ仕様で生成
            }

            // ---------------------------
            // 蛇の攻撃・生産・減速処理
            // ---------------------------
            snakes.forEach(s => {
                s.timer++;
                const t = getSnakeStats(s);

                // 所持金生成
                if (t.produceSec && s.timer % (t.produceSec * FPS) === 0) {
                    cost++;
                    costEffects.push({ x: s.x, y: s.y - 20, text: `+${t.produceAmmount}`, life: 30 });
                }

                // 攻撃
                enemies.forEach(e => {
                    const d = Math.hypot(e.x - s.x, e.y - s.y);
                    if (d < t.range && t.rate && s.timer % t.rate === 0) {
                        e.hp -= t.dmg || 0;
                        if (t.slow) {
                            e.slow = t.slow;
                            e.slowTimer = t.slowTime;
                        }
                        if (t.dmg && t.dmg > 0) {
                            effects.push({ x: e.x, y: e.y, text: `-${t.dmg}`, life: 30 });
                        }
                        if (t.poison) e.poison += t.poison;
                    }
                });
            });

            // ---------------------------
            // 敵の移動・HP減少
            // ---------------------------
            enemies.forEach(e => {
                if (e.slowTimer > 0) e.slowTimer--;
                else e.slow = 1;

                e.y += e.speed * e.slow;
                e.hp -= e.poison;

                if (e.y > defenseLine) gameOver = true;
            });

            // 倒れた敵削除
            for (let i = enemies.length - 1; i >= 0; i--) {
                if (enemies[i].hp <= 0) {
                    enemies.splice(i, 1);
                    enemiesDefeated++;
                }
            }

            // ---------------------------
            // エフェクト処理
            // ---------------------------
            for (let i = effects.length - 1; i >= 0; i--) {
                effects[i].y -= 0.5;
                effects[i].life--;
                if (effects[i].life <= 0) effects.splice(i, 1);
            }

            // UI更新
            const costEl = document.getElementById("cost");
            if (costEl) costEl.textContent = cost;
            const timeEl = document.getElementById("time");
            if (timeEl) timeEl.textContent = second;

            updateScoreUI();
        };


        // URLクエリパラメータから自動再生
        const params = new URLSearchParams(window.location.search);
        const kifParam = params.get("kif");

        if (kifParam) {
            try {
                const decoded = decodeURIComponent(kifParam);
                kifInput.value = decoded;

                // 自動再生
                loadBtn.click();

                // 入力欄非表示
                kifInput.style.display = "none";
                loadBtn.style.display = "none";
            } catch (e) {
                console.error("棋譜自動読み込み失敗:", e);
            }
        }
    </script>

</body>

</html>